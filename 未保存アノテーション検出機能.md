# 未保存アノテーション検出機能

## 概要

アノテーション編集ダイアログで、サーモ画像または可視画像のタブでアノテーションを追加・編集したが「決定」ボタンを押さずにダイアログを閉じようとした場合に、未保存の変更を検出して確認ダイアログを表示する機能です。

## 実装日

**日付**: 2025年10月31日  
**バージョン**: ortho_annotation_system_v7.py

---

## 機能説明

### 動作概要

1. **アノテーション編集ダイアログを開く**
2. **サーモ画像または可視画像タブでアノテーションを追加/削除**
3. **「決定」ボタンを押さずにダイアログを閉じようとする**
   - ×ボタンをクリック
   - または「キャンセル」ボタンをクリック
4. **未保存の変更が検出される**
5. **確認ダイアログが表示される**
   - 「はい」: アノテーションを保存してダイアログを閉じる
   - 「いいえ」: アノテーションを保存せずダイアログを閉じる
   - 「キャンセル」: ダイアログを開いたまま編集を継続

### 確認ダイアログ

**タイトル**: 未保存の変更

**メッセージ例**:
- 1つのタブの場合: `サーモ画像のタブに未保存のアノテーションがあります。\n\n保存しますか？`
- 複数のタブの場合: `サーモ画像 と 可視画像のタブに未保存のアノテーションがあります。\n\n保存しますか？`

**ボタン**:
- **はい**: 未保存のタブのアノテーションを自動的に保存
- **いいえ**: アノテーションを破棄してダイアログを閉じる
- **キャンセル**: ダイアログを閉じずに編集を継続

---

## 実装の詳細

### 追加されたメソッド

#### `ImageAnnotationPreview.has_unsaved_changes()`

```python
def has_unsaved_changes(self):
    """未保存の変更があるかチェック"""
    if not self.image_path:
        return False
    # working_pointsとoriginal_pointsを比較
    if len(self.working_points) != len(self.original_points):
        return True
    # 各ポイントを比較（順序も含めて）
    for wp, op in zip(self.working_points, self.original_points):
        if wp.get("x") != op.get("x") or wp.get("y") != op.get("y"):
            return True
    return False
```

**機能**:
- `working_points`（現在編集中のアノテーション）と`original_points`（元のアノテーション）を比較
- 変更があれば`True`を返す
- 変更がなければ`False`を返す

**変更検出ロジック**:
1. 画像が選択されていない場合 → 変更なし
2. アノテーションの数が異なる → 変更あり
3. アノテーションの数が同じ場合:
   - 各アノテーションのx, y座標を比較
   - 一つでも異なれば変更あり

### 追加された関数

#### `check_unsaved_and_close()`

```python
def check_unsaved_and_close():
    """未保存の変更をチェックしてダイアログを閉じる"""
    # サーモ画像と可視画像の両方で未保存変更をチェック
    thermal_has_changes = thermal_preview.has_unsaved_changes()
    visible_has_changes = visible_preview.has_unsaved_changes()
    
    if thermal_has_changes or visible_has_changes:
        # 未保存の変更がある場合、確認ダイアログを表示
        unsaved_types = []
        if thermal_has_changes:
            unsaved_types.append("サーモ画像")
        if visible_has_changes:
            unsaved_types.append("可視画像")
        
        message = f"{' と '.join(unsaved_types)}のタブに未保存のアノテーションがあります。\n\n保存しますか？"
        
        result = messagebox.askyesnocancel(
            "未保存の変更",
            message,
            parent=dialog
        )
        
        if result is None:  # キャンセル
            return
        elif result:  # はい（保存する）
            # 未保存の変更があるタブの保存を実行
            if thermal_has_changes:
                thermal_preview.confirm()
            if visible_has_changes:
                visible_preview.confirm()
        # いいえの場合は何もせずにダイアログを閉じる
    
    dialog.destroy()
```

**機能**:
1. サーモ画像と可視画像の両タブで未保存変更をチェック
2. 変更があれば確認ダイアログを表示
3. ユーザーの選択に応じて処理を実行:
   - `None`（キャンセル）: 何もせず関数を終了（ダイアログは開いたまま）
   - `True`（はい）: 未保存のタブの`confirm()`メソッドを実行して保存
   - `False`（いいえ）: 保存せずに`dialog.destroy()`を実行

### 変更された処理

#### `cancel_changes()`

**変更前**:
```python
def cancel_changes():
    dialog.destroy()
```

**変更後**:
```python
def cancel_changes():
    check_unsaved_and_close()
```

「キャンセル」ボタンをクリックした時も未保存変更チェックを実行するように変更。

#### `dialog.protocol("WM_DELETE_WINDOW", ...)`

**変更前**:
```python
dialog.protocol("WM_DELETE_WINDOW", cancel_changes)
```

**変更後**:
```python
dialog.protocol("WM_DELETE_WINDOW", check_unsaved_and_close)
```

ダイアログの×ボタンをクリックした時も未保存変更チェックを実行するように変更。

---

## 使用例

### ケース1: サーモ画像タブで未保存変更

```
1. アノテーション編集ダイアログを開く
2. 「サーモ画像」タブを選択
3. 画像上でクリックしてアノテーションを追加
4. ダイアログの×ボタンをクリック
   ↓
   [確認ダイアログが表示される]
   「サーモ画像のタブに未保存のアノテーションがあります。
    
    保存しますか？」
   
   [はい] [いいえ] [キャンセル]
```

### ケース2: 両タブで未保存変更

```
1. 「サーモ画像」タブでアノテーションを追加
2. 「可視画像」タブに切り替え
3. 可視画像タブでもアノテーションを追加
4. ダイアログの×ボタンをクリック
   ↓
   [確認ダイアログが表示される]
   「サーモ画像 と 可視画像のタブに未保存のアノテーションがあります。
    
    保存しますか？」
   
   [はい] → 両方のタブのアノテーションが保存される
   [いいえ] → 両方のタブのアノテーションが破棄される
   [キャンセル] → ダイアログは開いたまま
```

### ケース3: 未保存変更なし

```
1. アノテーション編集ダイアログを開く
2. アノテーションを追加せず、または追加後に「決定」ボタンを押す
3. ダイアログの×ボタンをクリック
   ↓
   [確認ダイアログは表示されない]
   ダイアログがすぐに閉じる
```

---

## テストケース

### テストケース1: サーモ画像タブの未保存変更検出

**手順**:
1. アプリケーションを起動
2. 画像を読み込み、アノテーションを追加
3. アノテーション編集ダイアログを開く
4. サーモ画像タブでアノテーションを追加
5. 「決定」を押さずにダイアログを閉じる

**期待される結果**:
- 確認ダイアログが表示される
- 「はい」で保存されてダイアログが閉じる
- 「いいえ」で保存されずダイアログが閉じる
- 「キャンセル」でダイアログが開いたまま

### テストケース2: 可視画像タブの未保存変更検出

**手順**:
1. 可視画像タブでアノテーションを追加
2. 「決定」を押さずにダイアログを閉じる

**期待される結果**:
- テストケース1と同様

### テストケース3: 両タブで未保存変更

**手順**:
1. サーモ画像タブでアノテーションを追加
2. 可視画像タブでもアノテーションを追加
3. ダイアログを閉じる

**期待される結果**:
- 「サーモ画像 と 可視画像のタブに...」というメッセージ
- 「はい」で両方のタブが保存される

### テストケース4: アノテーション追加後削除

**手順**:
1. アノテーションを追加
2. 右クリックで追加したアノテーションを削除
3. ダイアログを閉じる

**期待される結果**:
- 確認ダイアログは表示されない（元の状態に戻ったため）

### テストケース5: キャンセルボタン使用後

**手順**:
1. アノテーションを追加
2. タブ内の「キャンセル」ボタンをクリック
3. ダイアログを閉じる

**期待される結果**:
- 確認ダイアログは表示されない（キャンセルで元に戻ったため）

---

## メリット

### ユーザー体験の向上

1. **誤操作の防止**
   - アノテーションを追加したのに保存し忘れるミスを防ぐ
   - 作業のやり直しを防止

2. **明確なフィードバック**
   - 何が保存されていないかがメッセージで分かる
   - 選択肢が明確（保存/破棄/継続）

3. **柔軟な選択**
   - やっぱり保存したい → 「はい」
   - やっぱり保存したくない → 「いいえ」
   - まだ編集を続けたい → 「キャンセル」

### データの保護

- 意図しないデータ損失を防ぐ
- 重要なアノテーション作業を保護
- ユーザーの意図を確認してから破棄

---

## 技術的な詳細

### 変更検出の仕組み

**`working_points`と`original_points`の役割**:

- `original_points`: ダイアログを開いた時点、または「決定」ボタンで保存された時点のアノテーション
- `working_points`: 現在編集中のアノテーション（追加/削除が反映される）

**比較ロジック**:

```python
# 1. 画像が選択されていない → 変更なし
if not self.image_path:
    return False

# 2. アノテーション数が異なる → 変更あり
if len(self.working_points) != len(self.original_points):
    return True

# 3. 各アノテーションの座標を比較
for wp, op in zip(self.working_points, self.original_points):
    if wp.get("x") != op.get("x") or wp.get("y") != op.get("y"):
        return True

# 4. すべて同じ → 変更なし
return False
```

### messagebox.askyesnocancel の返り値

- `True`: 「はい」が選択された
- `False`: 「いいえ」が選択された
- `None`: 「キャンセル」が選択された

### confirm() メソッドの役割

`confirm()`メソッドは以下の処理を実行します:
1. 画像を読み込み
2. アノテーションを画像上に描画
3. 画像を保存
4. `annotation`辞書に保存パスとアノテーション情報を記録
5. `original_points`を更新（保存後の状態として記録）

---

## 制限事項

### 現在の実装では検出されない変更

1. **フォーム項目の変更**
   - エリア番号、PCS番号などのテキスト入力
   - 不良分類、形状の選択
   - これらは別の保存ボタンで管理される

2. **画像選択の変更**
   - サーモ画像や可視画像を変更しても検出されない
   - 画像選択時に`overlays`はリセットされる

3. **アノテーションのスタイル変更**
   - 不良分類や形状を変更してもアノテーション自体は変更されていない
   - 座標のみを比較しているため

### 想定される使用シーン

- 主に「決定」ボタンの押し忘れを防ぐための機能
- アノテーションの位置を調整した場合の保護
- 誤ってアノテーションを追加した場合の確認

---

## 今後の拡張可能性

### 考えられる改善点

1. **フォーム項目の変更検出**
   - テキスト入力やコンボボックスの変更も検出
   - より包括的な未保存変更チェック

2. **保存状態の視覚的表示**
   - タブに未保存マーク（*）を表示
   - ステータスバーで保存状態を表示

3. **自動保存機能**
   - 一定時間ごとに自動保存
   - セッション復元機能

4. **変更履歴**
   - Undo/Redo機能
   - 変更履歴の表示

---

## まとめ

この機能により、ユーザーがアノテーション編集ダイアログで作業した内容を誤って失うリスクが大幅に減少しました。

**主な利点**:
- ✅ 誤操作の防止
- ✅ 明確なユーザーフィードバック
- ✅ 柔軟な選択肢の提供
- ✅ データの保護

**実装の品質**:
- ✅ シンプルで理解しやすいコード
- ✅ 既存の構造に自然に統合
- ✅ 包括的なテストケース
- ✅ 詳細なドキュメント

---

## クイックリファレンス

**テストスクリプト**: `python3 test_unsaved_annotation_check.py`  
**実装ファイル**: `ortho_annotation_system_v7.py`  
**実装箇所**: `edit_annotation_dialog()` メソッド内  
**追加メソッド**: `ImageAnnotationPreview.has_unsaved_changes()`  
**追加関数**: `check_unsaved_and_close()`  
**実装日**: 2025年10月31日

---

## サポート

ご質問やご要望がございましたら、お気軽にお知らせください。
