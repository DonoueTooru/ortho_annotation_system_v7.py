プロジェクト名: Ortho Annotation System v7 - 不具合表拡張出力 + UI項目追加 + WebODM読込強化

## 目的・ゴール
- 太陽光発電所のオルソ画像に対するアノテーション業務を効率化し、WebODM資産との連携を安定化する。
- アノテーション結果（不具合一覧）を CSV / XLSX / JSON として整備し、保守・レポート業務に活用できるようにする。
- サーモ画像と可視画像をワンストップで突合・選択できる UI を整え、ドローン計測データの確認を高速化する。

## 現在実装済み機能
- **アノテーション編集ダイアログ強化**
  - 編集ダイアログ右側にサーモ／可視プレビュータブを配置し、クリックで仮アノテーションを追加・右クリックで削除できるワークフローを実装。決定ボタンを押したときだけ注釈入り画像を保存。
  - 不良分類名と一致する SVG アイコンをソフト同梱の「アノテーション画像フォルダ」から自動読込し、プレビュー／メインキャンバス／保存画像すべてで共通表示。アイコン欠如や cairosvg 未導入時は従来図形へフォールバックし、警告ログを出力。
  - プレビュー内で配置した座標は `thermal_overlays` / `visible_overlays` に保持し、ダイアログ再訪時に復元。形状・色は左カラムのコンボ選択と連動して即時反映。
  - 確定時は `ID{n}_{元ファイル名}_{thermal|visible}_annotated` の命名でプロジェクト配下に描画済み画像を出力し、パスをアノテーション辞書へ格納。
  - 「サーモ画像同時選択」ボタンを新設し、プレビュー付き専用ダイアログでサーモ画像と可視画像を上下比較しながら選択可能。
  - 同階層の「可視画像」フォルダにある *_V 画像を自動突合。可視画像が存在しない場合は「同名ファイルが見つかりません」と警告表示。
  - 選択確定後はサーモ画像（*_T）／可視画像（*_V）を同時適用し、アノテーションへ即時反映。
  - フォルダ選択直下に「ファイル名表示」「サムネイル表示」切替ボタンと表示件数コンボ、ページナビゲーション（前へ/次へ）を配置。リスト／サムネイル双方で 10 / 50 / 100 / 200 件のページング表示が可能。
  - サムネイル表示では、サーモ画像の縮小プレビューとファイル名をグリッド表示し、選択中アイテムをハイライト。フォルダ切替時はサムネイルキャッシュを自動クリア。
  - サムネイル表示中は上下左右キーでハイライトを移動でき、マウス操作なしでもプレビュー更新が可能。
  - ファイル一覧とプレビュー領域を左右のスプリッタでリサイズでき、閲覧重視・選択重視のどちらにも最適化可能。
  - サーモ／可視プレビューを上下スプリッタで個別に高さ調整でき、ズーム時の視認性をユーザが任意に確保。
  - ズームコントロールと倍率コンボをプレビュー枠下部に固定し、プレビュー拡大時でも視認性を維持。
  - プレビューセクションに縦スクロールを導入し、拡大時でもサーモ／可視プレビューを移動しながら確認可能。
  - プレビューエリアに虫眼鏡ボタン（±）と倍率コンボボックスを追加し、上下プレビューを 0.25〜3.0 倍までシンクロ拡大縮小。
  - スプリッタ位置は `~/.ortho_annotation_system_v7/layout.json` に自動保存され、次回ダイアログ起動時に復元。
  - ODM 経由のサーモ選択ボタン隣に「サーモ画像同時選択」ボタンを再配置し、ODM ワークフローから即座に可視画像まで選びきれる導線を整備。
  - 旧シグネチャを利用した呼び出しでも TypeError が出ないよう後方互換を確保。
  - 従来追加済みの項目（発見者・管理レベル・アレイ№ 等）を保持しつつ、UI レイアウトを調整。
- **WebODM 連携の堅牢化**
  - georeferencing（txt/csv）の多様なフォーマットを読取。
  - orthophoto 拡張子（.tif/.tiff/.png）ゆらぎ、coverage 画像欠如時の自動生成に対応。
  - world file の有無で座標変換を分岐し、アノテーション描画座標を統一。
  - ODMImageSelector にプレビュー枠・デバッグログを追加し、選択挙動を視覚化。
- **不具合リスト出力の拡張**
  - defect_list.csv に加え、20項目構成の defect_list_v2.csv / XLSX シート (defect_list_v2) を生成。
  - annotations.json に発見者・管理レベルなど追加属性を保持。
- **その他 UI/操作系**
  - WebODM フォルダ選択ボタン、色設定ダイアログ、マーカー操作の改善。
  - メインキャンバスでも「アノテーション画像フォルダ」の SVG アイコンを起動時に自動ロードし、アノテーション描画へ適用。欠如時は警告を出しつつ既存図形へフォールバック。
  - プロジェクト読込時にカスタム不良分類・図形リストを検出してコンボボックスとアイコンキャッシュを更新。
  - 不具合テーブルと編集ダイアログ双方で ID 番号を編集できるようにし、重複発生時は自動的に後続 ID を繰り上げつつ関連画像ファイル名も同期リネーム。

## エントリポイント / 実行方法
- ローカル実行: `python ortho_annotation_system_v7.py`
- 起動後フロー: プロジェクト新規作成 or 読込 → オルソ画像読込 → WebODM フォルダ設定（任意）→ アノテーション編集ダイアログで不具合登録。

## 公開 URL / API エンドポイント
- 本プロジェクトはスタンドアロン GUI アプリケーションです。公開 URL や外部 API エンドポイントは現在ありません。

## データモデル / ストレージ構造
- `annotations` (list[dict])
  - 主キー: `id`
  - 主要フィールド: `x`, `y`, `defect_type`, `shape`, `area_no`, `pcs_no`, `junction_box_no`, `circuit_no`, `array_no`, `module_position`, `serial_no`, `thermal_image`, `visible_image`, `thermal_overlays`, `visible_overlays`, `thermal_annotated_image`, `visible_annotated_image`, `remarks`, `report_date`, `management_level`, `found_by`
- `image_positions`: WebODM から取得した撮影画像のピクセル座標リスト `{filename, path, x, y}`
- `coverage_image`: WebODM coverage の PIL.Image インスタンス
- 出力ファイル: `annotations.json`, `defect_list.csv`, `defect_list_v2.csv`, `defect_list.xlsx`, `アノテーション入り画像`, `関連画像コピー`

## 主要クラス・関数一覧

### クラス
- `ODMImageSelector`
  - WebODM のカバレッジ画像をキャンバスに描画し、ジオリファレンス座標付きの撮影画像を選択するためのウィンドウを提供します。
  - マーカー描画・プレビュー更新・ズーム処理・画像選択確定など、ODM 資産との連携に必要な UI 操作をカプセル化します。
- `ThermalVisibleFileDialog`
  - サーモ画像と可視画像を同時にブラウズ・選択できるドッキング UI を実装したダイアログです。
  - リスト／サムネイル切替、ページング、ズーム、キーボード操作、レイアウト保存などアセット探索に関するインタラクションを担います。
- `OrthoImageAnnotationSystem`
  - 本アプリケーションのメインクラスで、Tkinter ベースの GUI、アノテーション管理、アイコン描画、出力ファイル生成など全体のワークフローを統括します。
  - プロジェクト保存、ID 採番調整、CSV/XLSX 生成、関連画像コピーといった業務フローを一元的に提供します。

### 関数（モジュールレベル）
- `normalize_management_level(value)`
  - 入力値を管理レベル定数（S/A/B/N）に正規化し、未設定や想定外の値を安全な既定値に丸めます。
- `_odmselector_debug_log(self, msg)`
  - ODM 画像選択ダイアログのデバッグログをコンソールへ出力するユーティリティです（monkey patch 用）。
- `_odmselector_update_preview(self, image_path)`
  - サムネイル／プレビュー枠で表示する画像をリサイズして差し替え、例外発生時はフォールバック表示に切り替えます。
- `_odmselector_select_image_by_index(self, index)`
  - カバレッジ上のマーカーとプレビューを連動させつつ、指定インデックスの撮影画像を選択状態に更新します。
- `_odmselector_create_selector_window(self)`
  - ODMImageSelector の初期ウィンドウ構築を拡張し、フォルダ選択ボタンやプレビュー領域を備えた UI を生成します。
- `_odmselector_norm_key(name)`
  - ファイル名から拡張子と大文字小文字の差異を除いた照合キーを生成し、ジオリファレンス情報との突合を容易にします。
- `_odmselector_select_images_folder(self)`
  - 画像フォルダを再帰的に走査してジオリファレンスと一致するファイルをマッピングし、マーカー一覧を再構成します。
- `_odmselector_update_info(self)`
  - カバレッジ画像のパスや選択中ファイルを含む情報ラベルを更新し、必要に応じてフォルダ選択を促します。
- `load_webodm_assets_robust(self)`
  - WebODM 資産読込処理を強化した関数で、複数フォーマットやワールドファイルへのフォールバックを含む堅牢な解析を提供します（ODMImageSelector に差し替え）。
- `main()`
  - Tkinter ルートを生成し `OrthoImageAnnotationSystem` を起動するエントリポイントです。

## 未実装 / 今後実装予定
- `select_webodm_folder` 側での georeferencing（csv/txt）の柔軟探索・自動判別
- プレビュータブで使用するアノテーション画像の選択 UI（仮実装から本実装への置き換え）
- EXIF / メタデータからの補助座標抽出
- エラーログのファイル出力および GUI 上での表示
- サーモ／可視突合時の命名ルールカスタマイズ（現状は末尾 T/V 前提）

## TODO計画（アノテーションダイアログ強化ロードマップ）
- [x] サーモ／可視同時選択ダイアログを刷新し、ODM 経由のパス選択と連携
- [x] リスト／サムネイル切替とズーム UI を導入し、プレビュー体験を向上
- [x] 大量ファイル向けに 10 / 50 / 100 / 200 件ページングと初期 100 件表示を実装
- [x] ズーム操作でプレビュー領域が拡大しても倍率コンボが視認できるレイアウト（固定位置化・スクロール同期など）の検討と実装
- [ ] サムネイルキャッシュのメモリ監視とバックグラウンド破棄処理の最適化
- [x] ファイル一覧／プレビュー領域を PanedWindow 等で分割し、ドラッグで個別リサイズできる UI を設計
- [x] プレビュー内のサーモ／可視ブロックそれぞれに最小サイズと可変比率を設け、ユーザ操作で高さ配分を調整可能にする
- [x] リサイズ設定をセッション間で保持する保存・読込フローを検討
- [ ] ODM 側メタデータからの自動可視画像推定ロジックを検証し、エラー時のフォールバックを追加

## 推奨次ステップ
- プレビュータブでの仮アノテーション配置→決定保存までの一連操作を実機データで検証し、保存された注釈画像とオーバーレイ座標が期待通りか確認。
- メインキャンバス上で SVG アイコンが期待通りスケーリングされるか、ズーム操作や JSON 再読込後も崩れないか確認。
- ID 編集後に重複が発生したケースで自動繰り上げと関連ファイルのリネームが期待通り行われるか確認。
- 「アノテーション画像フォルダ」の SVG 命名規則と cairosvg インストール状況を点検し、プロジェクト間で共有できるアイコン配備ガイドラインを整備。
- 大容量（数千件）フォルダを用いたページング動作確認と表示件数切替の UX 検証。
- 実際の WebODM アセットフォルダを用いた総合動作テスト（サーモ・可視の同時プレビュー含む）。
- 可視画像フォルダが存在しないケースや命名崩れデータでのハンドリング検証。
- georeferencing ファイルのフォーマット別サンプルを収集し、正規表現ルールのチューニング。
- マーカー選択距離など UI パラメータの設定化。
- サムネイル表示の列数や縮小サイズ、既定表示モード（リスト/サムネイル）の設定化を検討。

## 手動テスト推奨シナリオ
1. プレビュータブでサーモ画像を表示し、左クリックでアノテーションを追加→右クリックで削除→「決定」押下で注釈入り画像が生成されること、および「キャンセル」押下では保存されないことを確認。
2. 「アノテーション画像フォルダ」に対象 SVG が存在する状態で、不良分類を切り替えながらプレビュー／メインキャンバス／保存画像に同一アイコンが表示されることを確認。アイコンを一時的にリネームして欠如させ、フォールバックの図形表示と警告ログ出力を確認。
3. サーモ画像が 200 件を超えるフォルダでダイアログを開き、10 / 50 / 100 / 200 の表示件数切替とページナビゲーションが期待通りに動作することを確認。
4. リスト表示とサムネイル表示を切替えても選択中のサーモ画像が維持され、プレビューが同期して更新されることを確認。
5. 拡大・縮小ボタンと倍率コンボを操作し、上下プレビューが 0.25〜3.0 倍の範囲で同期して変化することを確認。
6. 可視画像が存在しないサーモファイルを選択した際に、警告表示とプレビューのメッセージが適切に更新されることを確認。
7. 旧コードからの呼び出し（`set_selected_file(..., source="list")` など）が残っている環境で TypeError が発生しないことを確認。
8. 左右スプリッタをドラッグしてファイル一覧とプレビューの幅を調整し、意図通りのレイアウトにできるか確認。
9. 上下スプリッタを操作してサーモ／可視プレビューの高さ配分を変更し、ズーム後も視認性を保てるか確認。
10. スプリッタを調整後にダイアログを閉じ、再度開いて保存されたレイアウトが復元されるか確認。
11. JPEG 形式で出力されるサーモ／可視の注釈付き画像を保存し、以前発生していた「cannot write mode RGBA as JPEG」エラーが再現しないことを確認。
12. 不具合テーブルおよび編集ダイアログで ID を編集し、重複がある場合に自動で繰り上げられること、対応するサーモ・可視・注釈付き画像のファイル名が新しい ID にリネームされることを確認。

## 更新履歴ハイライト (Latest)
- 不良分類ごとの SVG アノテーションアイコンを導入し、プレビュー／メイン画面／保存画像の描画を統一。アイコン欠如時は既存図形へ自動フォールバック。
- アノテーション編集ダイアログ右カラムにサーモ／可視タブ付きプレビューを追加し、クリック配置・右クリック削除・決定保存の新フローと注釈画像の自動出力を実装。
- プレビューセクションを再レイアウトし、ズームコントロール／倍率コンボを下部固定しつつ縦スクロール対応で拡大時の視認性を確保。
- ファイル一覧／プレビューおよびサーモ／可視プレビューを PanedWindow でリサイズ可能にし、分割位置を自動保存・復元。
- サーモ画像同時選択ダイアログに表示件数コンボとページナビゲーションを追加し、10 / 50 / 100 / 200 件のページングと初期 100 件表示を実装。
- 表示モード切替（ファイル名/サムネイル）とズーム UI を統合し、虫眼鏡ボタン＋倍率コンボで 0.25〜3.0 倍の同期拡大縮小を実現。
- アノテーション編集ダイアログ内の「サーモ画像同時選択」ボタンを ODM 選択ボタン横に再配置し、ODM ワークフローとの導線を短縮。
- 旧シグネチャの `set_selected_file(..., source="list")` 呼び出しを受けても TypeError が発生しないよう互換ハンドリングを追加。
- サーモ／可視ダイアログで選択したパスを直近フォルダとして記憶し、次回以降のナビゲーションを短縮。
- アノテーション入り画像を JPEG で保存する際に RGBA→RGB 変換を自動挿入し、「cannot write mode RGBA as JPEG」エラーを恒久的に解消。
- 既存の WebODM 読込ロジック・CSV/XLSX 出力強化は引き続き利用可能。

### 2025-10-20 プレビュー縦伸び改善
- ThermalVisibleFileDialog のプレビュー領域を縦方向にしっかり拡げる修正を実施。
  - `_on_preview_canvas_configure` に `height` 追従を追加し、キャンバス内の余白を除去。
  - `restore_layout_preferences` で `preview_ratio = 10.0` の固定上書きを廃止し、`*2` 倍算と `sashpos(0, 1000)` の強制固定を撤廃。保存済み比率をそのまま復元。
- 影響範囲: サーモ／可視の上下分割プレビューが、ウィンドウの高さ変更やスプリッタ操作に正しく追従し、画像が見切れにくくなりました。

## トラブルシュート
- WebODM 資産読込で失敗する場合は以下を確認してください。
  - エラーメッセージ全文（スタックトレース）
  - `odm_georeferencing` 配下のファイル名一覧
  - georeferencing ファイルの先頭 20 行程度のサンプル
  - `odm_orthophoto` 配下のファイル名と拡張子
- サーモ画像同時選択ダイアログで可視画像が見つからない場合
  - サーモ画像と同階層（同じ親フォルダ）に `可視画像` フォルダが存在するか確認
  - ファイル末尾が `_V` の命名になっているか再確認
- メイン画面でアノテーションアイコンが表示されない/警告が出る場合
  - プログラムと同階層にある `アノテーション画像フォルダ` に SVG ファイルが配置されているか確認
  - cairosvg がインストール済みか (`pip install cairosvg`) を確認
  - フォルダを後から追加した場合はメイン画面の「保存」などリロード挙動をトリガーするかアプリを再起動してアイコンキャッシュを更新
- ID 変更後に関連ファイル名が更新されない場合
  - プロジェクト配下に対象ファイルが存在するか確認（外部ストレージ上のオリジナルファイルは自動リネーム対象外）
  - ファイル名内に `ID###` 形式が含まれているか確認し、含まれていない場合は手動でリネームするか再出力を実施
  - OS によっては権限不足でリネームがブロックされることがあるため、権限設定を確認
- サムネイルが表示されない場合
  - 対象ファイルが IMAGE_EXTS（.jpg/.jpeg/.png/.bmp/.tif/.tiff）に含まれているか確認
  - 破損ファイルや極端に大きな画像は縮小に失敗することがあります。その場合は元画像の整合性を確認してください。
- ページングが期待通りに切り替わらない場合
  - 表示件数コンボが数値（10 / 50 / 100 / 200）のいずれかに設定されているか確認し、必要なら再選択してください。
  - ページナビゲーションを押しても変化がないときは、フォルダ内のサーモ画像が上限件数未満かどうか、およびアクセス権限があるかを確認したうえで「フォルダ選択」から再スキャンを実行してください。
