# アノテーション画像フォルダ振り分け機能

## 概要

アノテーション編集ダイアログでサーモ画像および可視画像のアノテーション入り画像を保存する際に、画像タイプに応じて専用のサブフォルダに自動的に振り分けて保存する機能です。

## 実装日

**日付**: 2025年10月31日  
**バージョン**: ortho_annotation_system_v7.py

---

## 機能説明

### 動作概要

**変更前**:
```
アノテーション入り画像フォルダ/
├── ID001_image1_thermal_annotated.jpg
├── ID001_image2_visible_annotated.jpg
├── ID002_image3_thermal_annotated.jpg
├── ID002_image4_visible_annotated.jpg
└── ... (すべての画像が同じフォルダに保存)
```

**変更後**:
```
アノテーション入り画像フォルダ/
├── サーモ画像フォルダ/
│   ├── ID001_image1_thermal_annotated.jpg
│   ├── ID002_image3_thermal_annotated.jpg
│   └── ...
└── 可視画像フォルダ/
    ├── ID001_image2_visible_annotated.jpg
    ├── ID002_image4_visible_annotated.jpg
    └── ...
```

### 主な特徴

1. **自動振り分け**
   - サーモ画像 → `サーモ画像フォルダ`
   - 可視画像 → `可視画像フォルダ`

2. **自動フォルダ作成**
   - 必要に応じてサブフォルダを自動作成
   - 既存フォルダがあってもエラーにならない

3. **ファイル名は変更なし**
   - 従来通りの形式: `ID{番号}_{元ファイル名}_{画像タイプ}_annotated{拡張子}`

4. **後方互換性**
   - 既存のプロジェクトでも正常に動作
   - 既存の画像ファイルには影響なし

---

## フォルダ構造

### 完全なプロジェクト構造

```
プロジェクトフォルダ/
│
├── アノテーション入り画像フォルダ/
│   ├── サーモ画像フォルダ/          ← 新規追加
│   │   ├── ID001_IR001_thermal_annotated.jpg
│   │   ├── ID001_IR002_thermal_annotated.jpg
│   │   ├── ID002_IR003_thermal_annotated.jpg
│   │   └── ...
│   └── 可視画像フォルダ/            ← 新規追加
│       ├── ID001_RGB001_visible_annotated.jpg
│       ├── ID001_RGB002_visible_annotated.jpg
│       ├── ID002_RGB003_visible_annotated.jpg
│       └── ...
│
├── 全体図位置フォルダ/
│   ├── ID001_全体図_不具合名.jpg
│   └── ...
│
├── 不具合一覧表フォルダ/
│   ├── defect_list.csv
│   ├── defect_list_v2.xlsx
│   └── ...
│
├── annotations.json
├── 全体図アノテーション.jpg
└── ...
```

---

## 実装の詳細

### 変更箇所

**ファイル**: `ortho_annotation_system_v7.py`  
**メソッド**: `ImageAnnotationPreview.confirm()`  
**行数**: 約3371-3388行目

### 変更内容

#### 変更前のコード

```python
if getattr(self.outer, "project_path", None):
    base_dir = os.path.join(self.outer.project_path, "アノテーション入り画像フォルダ")
else:
    base_dir = os.path.join(os.path.dirname(self.image_path), "annotated")
os.makedirs(base_dir, exist_ok=True)

name, ext = os.path.splitext(os.path.basename(self.image_path))
if not ext:
    ext = ".png"
output_path = os.path.join(base_dir, f"ID{self.annotation['id']}_{name}_{self.image_type}_annotated{ext}")
```

#### 変更後のコード

```python
if getattr(self.outer, "project_path", None):
    base_dir = os.path.join(self.outer.project_path, "アノテーション入り画像フォルダ")
else:
    base_dir = os.path.join(os.path.dirname(self.image_path), "annotated")

# 画像タイプに応じてサブフォルダを作成
if self.image_type == "thermal":
    type_dir = os.path.join(base_dir, "サーモ画像フォルダ")
elif self.image_type == "visible":
    type_dir = os.path.join(base_dir, "可視画像フォルダ")
else:
    type_dir = base_dir

os.makedirs(type_dir, exist_ok=True)

name, ext = os.path.splitext(os.path.basename(self.image_path))
if not ext:
    ext = ".png"
output_path = os.path.join(type_dir, f"ID{self.annotation['id']}_{name}_{self.image_type}_annotated{ext}")
```

### 主な変更ポイント

1. **画像タイプ判定の追加**
   ```python
   if self.image_type == "thermal":
       type_dir = os.path.join(base_dir, "サーモ画像フォルダ")
   elif self.image_type == "visible":
       type_dir = os.path.join(base_dir, "可視画像フォルダ")
   else:
       type_dir = base_dir
   ```

2. **サブフォルダパスの生成**
   - `base_dir`: アノテーション入り画像フォルダ
   - `type_dir`: base_dir + 画像タイプ別サブフォルダ

3. **フォルダ作成処理の変更**
   - 変更前: `os.makedirs(base_dir, exist_ok=True)`
   - 変更後: `os.makedirs(type_dir, exist_ok=True)`

4. **保存パスの変更**
   - 変更前: `os.path.join(base_dir, filename)`
   - 変更後: `os.path.join(type_dir, filename)`

---

## 使用例

### 基本的な使用フロー

```
1. アノテーション編集ダイアログを開く
   ↓
2. サーモ画像タブを選択
   ↓
3. サーモ画像を選択
   ↓
4. アノテーションを追加
   ↓
5. 「決定」ボタンをクリック
   ↓
6. [新機能] サーモ画像フォルダに自動保存
   保存先: アノテーション入り画像フォルダ/サーモ画像フォルダ/ID001_xxx_thermal_annotated.jpg

---

7. 可視画像タブを選択
   ↓
8. 可視画像を選択
   ↓
9. アノテーションを追加
   ↓
10. 「決定」ボタンをクリック
    ↓
11. [新機能] 可視画像フォルダに自動保存
    保存先: アノテーション入り画像フォルダ/可視画像フォルダ/ID001_xxx_visible_annotated.jpg
```

### ファイル名の例

**サーモ画像**:
```
ID001_IR_IMAGE_001_thermal_annotated.jpg
ID002_THERMAL_DATA_thermal_annotated.png
ID003_サーモ撮影_thermal_annotated.jpg
```

**可視画像**:
```
ID001_RGB_IMAGE_001_visible_annotated.jpg
ID002_VISIBLE_DATA_visible_annotated.png
ID003_可視撮影_visible_annotated.jpg
```

---

## メリット

### 1. 整理整頓

**変更前**: すべての画像が1つのフォルダに混在
- サーモ画像と可視画像が混ざって見つけにくい
- ファイル数が多くなると管理が困難

**変更後**: 画像タイプごとに整理
- 目的の画像を素早く見つけられる
- フォルダ内のファイル数が減少

### 2. 作業効率の向上

- サーモ画像だけを確認したい時 → サーモ画像フォルダを開く
- 可視画像だけを確認したい時 → 可視画像フォルダを開く
- 選択的なコピー・バックアップが容易

### 3. ファイル管理の改善

- フォルダ構造が明確で分かりやすい
- 画像タイプごとの統計が取りやすい
- バックアップ時に必要な画像だけを選択できる

### 4. プロジェクト構造の標準化

- どのプロジェクトでも同じ構造
- チームメンバー間での共有が容易
- ドキュメント作成時の説明が簡単

---

## テストケース

### テストケース1: サーモ画像の保存

**手順**:
1. アノテーション編集ダイアログを開く
2. サーモ画像タブでアノテーションを追加
3. 「決定」ボタンをクリック

**期待結果**:
- ✓ `アノテーション入り画像フォルダ/サーモ画像フォルダ/` に保存される
- ✓ ファイル名: `ID{番号}_xxx_thermal_annotated.{拡張子}`

### テストケース2: 可視画像の保存

**手順**:
1. アノテーション編集ダイアログを開く
2. 可視画像タブでアノテーションを追加
3. 「決定」ボタンをクリック

**期待結果**:
- ✓ `アノテーション入り画像フォルダ/可視画像フォルダ/` に保存される
- ✓ ファイル名: `ID{番号}_xxx_visible_annotated.{拡張子}`

### テストケース3: 両タイプの保存

**手順**:
1. サーモ画像と可視画像の両方でアノテーションを保存
2. フォルダ構造を確認

**期待結果**:
- ✓ サーモ画像フォルダとvisible画像フォルダが両方作成される
- ✓ 各フォルダに対応する画像が保存される

### テストケース4: フォルダの自動作成

**手順**:
1. 新しいプロジェクトを作成（フォルダが存在しない状態）
2. サーモ画像のアノテーション入り画像を保存

**期待結果**:
- ✓ アノテーション入り画像フォルダが自動作成される
- ✓ サーモ画像フォルダが自動作成される
- ✓ 画像が正しく保存される

### テストケース5: 既存画像の上書き

**手順**:
1. 既にサーモ画像を保存済みのアノテーションを編集
2. アノテーションを変更して再度「決定」

**期待結果**:
- ✓ 同じファイルパスで上書き保存される
- ✓ 変更内容が反映される

---

## 後方互換性

### 既存プロジェクトへの影響

**既存の画像ファイル**:
- ✅ 影響なし（そのまま残る）
- ✅ 新しく保存する画像から新構造が適用される

**既存のアノテーション情報**:
- ✅ 影響なし（JSON内のパス情報は保持される）
- ✅ 既存の画像は元の場所を参照し続ける

**新規保存時の動作**:
- ✅ 新しいフォルダ構造に従って保存される
- ✅ ファイル名形式は変更なし

### 移行の必要性

**必要なし**:
- 既存プロジェクトはそのまま使用できる
- 段階的に新構造に移行される
- 手動での移行作業は不要

---

## 技術的な詳細

### 画像タイプの判定

```python
self.image_type  # "thermal" または "visible"
```

この値は`ImageAnnotationPreview`クラスの初期化時に設定されます。

### フォルダ作成のロジック

```python
os.makedirs(type_dir, exist_ok=True)
```

- `exist_ok=True`: フォルダが既に存在してもエラーにならない
- 親フォルダも自動的に作成される
- パーミッションエラーが発生する可能性あり（書き込み権限が必要）

### パス生成の流れ

```
1. base_dir を取得
   ↓
2. image_type を確認
   ↓
3. type_dir を生成 (base_dir + サブフォルダ名)
   ↓
4. type_dir を作成
   ↓
5. output_path を生成 (type_dir + ファイル名)
   ↓
6. 画像を保存
```

### エラーハンドリング

```python
try:
    file_ext = os.path.splitext(output_path)[1].lower()
    save_image = working_image
    if file_ext in (".jpg", ".jpeg") and save_image.mode not in ("RGB", "L"):
        save_image = save_image.convert("RGB")
    save_image.save(output_path)
except Exception as e:
    messagebox.showerror("エラー", f"注釈付き画像の保存に失敗しました: {e}")
    return
```

保存時のエラーは適切にキャッチされ、ユーザーに通知されます。

---

## 制限事項

### 現在の制限

1. **サブフォルダの名前は固定**
   - サーモ画像フォルダ
   - 可視画像フォルダ
   - カスタマイズ不可

2. **thermal と visible 以外のタイプ**
   - base_dir 直下に保存される
   - サブフォルダは作成されない

3. **既存画像の自動移行なし**
   - 旧構造の画像は手動で移動が必要
   - ただし、通常は移動不要（そのまま使用可能）

### 想定される使用シーン

- 新規プロジェクト作成時
- 既存プロジェクトへの新しいアノテーション追加時
- アノテーション入り画像の再生成時

---

## 今後の拡張可能性

### 考えられる改善点

1. **フォルダ名のカスタマイズ**
   - 設定画面でフォルダ名を変更可能に
   - プロジェクトごとの設定

2. **既存画像の自動移行**
   - プロジェクト読み込み時に旧構造を検出
   - ユーザーに移行を提案
   - ワンクリックで新構造に移行

3. **統計情報の表示**
   - 各フォルダのファイル数を表示
   - 容量の表示

4. **フォルダの一括操作**
   - サーモ画像フォルダの一括zip圧縮
   - 可視画像フォルダの一括コピー

5. **追加の画像タイプ対応**
   - 他の画像タイプ用のフォルダ
   - カスタム画像タイプの定義

---

## トラブルシューティング

### 問題: フォルダが作成されない

**原因**: 書き込み権限がない

**解決策**:
1. プロジェクトフォルダの権限を確認
2. 管理者権限でアプリケーションを実行
3. 別のフォルダにプロジェクトを作成

### 問題: 画像が見つからない

**原因**: パス情報が古い

**解決策**:
1. アノテーションを再度編集して保存
2. 新しいフォルダ構造で保存される

### 問題: 古い画像と新しい画像が混在

**原因**: 段階的な移行による

**解決策**:
- 問題なし（両方とも正常に動作）
- 必要に応じて手動で整理

---

## まとめ

この機能により、アノテーション入り画像の管理が大幅に改善されました。

**主な利点**:
- ✅ 画像タイプごとに整理
- ✅ 目的の画像を素早く発見
- ✅ 作業効率の向上
- ✅ プロジェクト構造の標準化

**実装の品質**:
- ✅ シンプルで理解しやすい
- ✅ 後方互換性を維持
- ✅ 自動フォルダ作成
- ✅ エラーハンドリング完備

---

## クイックリファレンス

**テストスクリプト**: `python3 test_annotation_folder_separation.py`  
**実装ファイル**: `ortho_annotation_system_v7.py`  
**実装メソッド**: `ImageAnnotationPreview.confirm()`  
**実装箇所**: 約3371-3388行目  
**実装日**: 2025年10月31日

**フォルダ構造**:
```
アノテーション入り画像フォルダ/
├── サーモ画像フォルダ/
└── 可視画像フォルダ/
```

**ファイル名形式**:
```
ID{番号}_{元ファイル名}_{画像タイプ}_annotated{拡張子}
```

---

## サポート

ご質問やご要望がございましたら、お気軽にお知らせください。
