# Requirement 1: 画像保存統一機能の実装完了報告

## 概要
サーモ画像・可視画像の保存方法を統一し、アノテーション入り画像のみを保存するように変更しました。オフセット設定も適用されます。

## 実装日時
2025-11-06

## 実装内容

### 1. `copy_related_images()` メソッドの完全書き換え ✅
**場所**: Line 5017-5163

**変更前の動作**:
```python
# 単純なファイルコピー
shutil.copy2(src_path, dst_path)
```

**変更後の動作**:
1. 元画像を読み込み (`Image.open()`)
2. アノテーションを描画 (`_draw_annotation_on_related_image()`)
3. オフセット設定を適用 (`image_type='thermal'` または `'visible'`)
4. 命名規則に従ってファイルを保存

**主要な特徴**:
- **アノテーション入り画像のみを保存** (要件達成)
- **オフセット自動適用** (Requirement 2との連携)
- **スケール倍率対応** (thermal/visible個別設定)
- **JPEG形式対応** (RGBA → RGB変換)
- **エラーハンドリング** (個別の画像処理失敗でも継続)

### 2. 新メソッド: `_draw_annotation_on_related_image()` ✅
**場所**: Line 5100-5163

**役割**: サーモ/可視画像にアノテーションを描画

**引数**:
- `image`: 元画像 (PIL Image)
- `x, y`: アノテーション座標
- `annotation_id`: アノテーションID
- `defect_type`: 不具合タイプ
- `color`: 色
- `shape`: 形状
- `image_type`: 画像タイプ (`'thermal'` または `'visible'`)

**処理フロー**:
```python
1. 画像をコピー (元画像を保護)
2. ImageDraw オブジェクト作成
3. スケール倍率を取得
   - thermal → self._get_annotation_scale('thermal')
   - visible → self._get_annotation_scale('visible')
4. アノテーションアイコン/シェイプを描画
   - draw_annotation_icon_on_image(image_type=image_type)
   - オフセット自動適用
5. ID番号ラベルを描画
   - _draw_id_label_on_image(image_type=image_type)
   - オフセット自動適用
6. 描画済み画像を返す
```

**重要なポイント**:
- `image_type` パラメータを渡すことで、Requirement 2で実装したオフセット機能が自動適用される
- スケール倍率は thermal/visible 個別設定を使用

### 3. 命名規則の統一 ✅

**採用した命名規則** (既存の規則を維持):
```python
# サーモ画像
f"ID{annotation_id:03d}_{defect_type}_サーモ異常{ext}"
# 例: ID001_ホットスポット_サーモ異常.jpg

# 可視画像
f"ID{annotation_id:03d}_{defect_type}_可視異常{ext}"
# 例: ID001_ホットスポット_可視異常.jpg
```

**特徴**:
- ID番号は3桁ゼロパディング (`001`, `002`, ...)
- 不具合タイプを含む
- 拡張子は元画像のものを維持
- CSV/Excel出力の命名規則と完全一致

### 4. フォルダ構成 ✅

**保存先**:
- サーモ画像: `{project_path}/サーモ画像フォルダ/`
- 可視画像: `{project_path}/可視画像フォルダ/`

**注意**:
- フォルダ名は既存のまま維持（後方互換性）
- アノテーション入り画像のみ保存（アノテーションなし画像は保存されない）

### 5. 画像形式対応 ✅

**JPEG形式の特別処理**:
```python
if ext.lower() in ['.jpg', '.jpeg']:
    if annotated_image.mode == 'RGBA':
        # 白背景に合成してRGB変換
        rgb_image = Image.new('RGB', annotated_image.size, (255, 255, 255))
        rgb_image.paste(annotated_image, mask=annotated_image.split()[3])
        annotated_image = rgb_image
    elif annotated_image.mode != 'RGB':
        annotated_image = annotated_image.convert('RGB')
    annotated_image.save(dst_path, 'JPEG', quality=95)
else:
    annotated_image.save(dst_path)
```

**対応形式**:
- PNG: そのまま保存 (アルファチャンネル保持)
- JPEG: RGB変換後、品質95%で保存
- その他: 自動判別で保存

## Requirement 2 との連携

### オフセット適用の仕組み

**Requirement 2で実装した機能**:
- `draw_annotation_icon_on_image(image_type=None)` パラメータ
- `_draw_id_label_on_image(image_type=None)` パラメータ
- オフセット値: `thermal_offset_x/y`, `visible_offset_x/y`

**Requirement 1での活用**:
```python
# サーモ画像にアノテーション描画
self.draw_annotation_icon_on_image(
    ...,
    image_type='thermal'  # ← thermal_offset_x/y が自動適用される
)

# 可視画像にアノテーション描画
self.draw_annotation_icon_on_image(
    ...,
    image_type='visible'  # ← visible_offset_x/y が自動適用される
)
```

**結果**:
- ユーザーが設定したオフセット値が、保存時に自動的に適用される
- サーモ画像と可視画像で異なるオフセットを使用可能
- 設定変更後の保存で即座に反映される

## 使用方法

### 基本的な使用フロー

1. **プロジェクト作成・読み込み**
2. **オルソ画像にアノテーションを配置**
3. **サーモ画像・可視画像を各アノテーションに関連付け**
4. **(オプション) オフセット設定を調整**
   - 「色設定」→「アノテーション位置調整」
   - サーモ/可視それぞれのX/Y値を設定
5. **「保存」ボタンをクリック**
6. **結果確認**
   - `サーモ画像フォルダ/`: アノテーション入りサーモ画像
   - `可視画像フォルダ/`: アノテーション入り可視画像

### オフセット調整のワークフロー

**初回保存後の調整**:
1. 保存された画像を確認
2. アノテーション位置のずれを測定（ピクセル単位）
3. 「色設定」→「アノテーション位置調整」で補正値を入力
4. 再度「保存」を実行
5. ずれが解消されるまで繰り返し

**推奨される調整方法**:
- まずは小さな値（±10〜20px）から試す
- X軸とY軸を個別に調整
- 複数の画像で確認してから確定

## 技術的な詳細

### エラーハンドリング

**個別画像の処理失敗**:
```python
try:
    # 画像処理
except Exception as e:
    print(f"[WARN] サーモ画像の処理に失敗 (ID{annotation_id}): {e}")
    # 次の画像の処理を継続
```

**特徴**:
- 1つの画像で失敗しても、他の画像の処理は継続
- エラーメッセージはコンソールに出力
- ユーザーに対してエラーダイアログは表示しない（保存処理全体は継続）

### パフォーマンス考慮事項

**画像処理のコスト**:
- 画像読み込み: `Image.open()`
- アノテーション描画: PIL描画処理
- 画像保存: ファイル書き込み

**最適化**:
- 各画像を1回だけ読み込み・保存
- 不要なコピーを最小化
- JPEG品質95%でファイルサイズと品質のバランス

### メモリ使用

**画像コピーのタイミング**:
```python
annotated_image = image.copy()  # 元画像を保護
```

**理由**:
- 元画像を変更しない（複数アノテーションで再利用可能）
- メモリ効率より安全性を優先

## 変更の影響範囲

### 影響を受ける機能
1. **プロジェクト保存** (`save_project()`)
   - `copy_related_images()` を呼び出し
   - 動作は変わらないが、保存内容が変化

2. **CSV/Excel出力**
   - ファイル名の参照は変わらない（命名規則が同じため）
   - アノテーション入り画像を参照するようになる

### 影響を受けない機能
1. **アノテーション編集**
2. **オルソ画像表示**
3. **全体図保存** (`save_individual_annotated_images()`)
4. **プロジェクト読み込み**

## 後方互換性

### 既存プロジェクトへの影響

**問題なく動作する**:
- 既存のアノテーションデータ
- 既存の画像パス参照
- 既存のCSV/Excel出力

**変更される点**:
- 次回保存時から、アノテーション入り画像が保存される
- アノテーションなし画像は上書きされる（事前バックアップ推奨）

### 注意事項

**重要**: 既存プロジェクトの画像を保護したい場合:
1. プロジェクトフォルダ全体をバックアップ
2. 特に `サーモ画像フォルダ/` と `可視画像フォルダ/` を別途コピー
3. その後、新機能で保存を実行

## テスト項目

### 必須テスト
- [ ] アノテーション入り画像のみ保存されることを確認
- [ ] 命名規則の一貫性確認 (`ID{id:03d}_{defect_type}_サーモ異常/可視異常{ext}`)
- [ ] オフセット設定が正しく適用されることを確認
- [ ] JPEG形式の画像が正しくRGB変換されることを確認
- [ ] PNG形式の画像が透明度を保持して保存されることを確認

### エッジケースのテスト
- [ ] サーモ画像のみ関連付けられている場合
- [ ] 可視画像のみ関連付けられている場合
- [ ] 両方とも関連付けられていない場合
- [ ] 画像ファイルが存在しない場合のエラーハンドリング
- [ ] 特殊文字を含む不具合タイプ名の処理

## 実装統計

### コード変更量
- **削除**: 18行（旧 `copy_related_images()`）
- **追加**: 147行（新 `copy_related_images()` + `_draw_annotation_on_related_image()`）
- **純増**: +129行

### 主要な変更箇所
1. Line 5017-5099: `copy_related_images()` 書き換え
2. Line 5100-5163: `_draw_annotation_on_related_image()` 新規追加

## まとめ

### 達成した要件
✅ **Requirement 1**: 画像保存の統一
1. アノテーション入り画像のみを保存
2. アノテーションなし画像は保存しない
3. 命名規則を統一
4. オフセット設定を適用（Requirement 2との連携）

### 追加の利点
1. **スケール倍率対応**: thermal/visible個別設定を使用
2. **エラー耐性**: 個別画像の失敗が全体に影響しない
3. **形式対応**: JPEG/PNG/その他を自動処理
4. **後方互換性**: 既存プロジェクトも問題なく動作

### Requirement 2との完全統合
- オフセット機能が実際の保存時に活用される
- ユーザーの設定が確実に反映される
- サーモ/可視で異なる補正が可能

## 次のステップ

### 推奨される作業
1. **コミット**: 変更をgitにコミット
2. **PR作成**: Pull Request作成
3. **テスト**: 実際のプロジェクトでテスト
4. **ドキュメント更新**: ユーザーマニュアルの更新

### 今後の改善案（オプション）
1. **プレビュー機能**: 保存前にアノテーション入り画像をプレビュー
2. **バッチ処理**: 複数画像の一括オフセット調整
3. **履歴管理**: オフセット設定の変更履歴を保存
4. **自動調整**: 画像特徴量からオフセットを自動推定

## 参考情報

### 関連ドキュメント
- `REQUIREMENT2_OFFSET_IMPLEMENTATION.md`: オフセット機能の実装詳細
- `ortho_annotation_system_v7.py`: メインソースコード

### 関連メソッド
- `save_project()`: プロジェクト保存のエントリーポイント
- `draw_annotation_icon_on_image()`: アイコン描画（オフセット対応）
- `_draw_id_label_on_image()`: IDラベル描画（オフセット対応）
- `_get_annotation_scale()`: スケール倍率取得
